<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BE CAUSE | Control</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Syncopate:wght@400;700&family=Inter:wght@300;400;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #000; color: white; margin: 0; padding: 0; overflow: hidden; height: 100vh; }
        #rainCanvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; pointer-events: none; }
        .font-logo { font-family: 'Syncopate', sans-serif; }
        .section { display: none; position: relative; z-index: 10; height: 100vh; width: 100vw; overflow-y: auto; padding: 20px; padding-bottom: 120px; }
        .section.active { display: block; animation: fadeIn 0.4s ease; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .glass { background: rgba(15, 15, 15, 0.8); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 24px; }
        nav { position: fixed; bottom: 0; left: 0; width: 100%; background: rgba(0,0,0,0.9); backdrop-filter: blur(20px); z-index: 100; border-top: 1px solid rgba(255,255,255,0.1); display: flex; justify-content: space-around; padding: 25px; }
        .nav-btn { font-size: 10px; font-weight: 900; letter-spacing: 2px; text-transform: uppercase; opacity: 0.4; transition: 0.3s; }
        .nav-btn.active { opacity: 1; border-bottom: 2px solid white; }
        input[type="date"]::-webkit-calendar-picker-indicator { filter: invert(1); }
    </style>
</head>
<body>
    <canvas id="rainCanvas"></canvas>

    <section id="home" class="section active">
        <div class="flex flex-col items-center justify-center min-h-full">
            <h1 class="font-logo text-2xl tracking-[0.5em] mb-12 italic">BE CAUSE</h1>
            <div id="clock" class="text-7xl font-black italic tracking-tighter mb-2">00:00</div>
            <p id="date-display" class="text-gray-500 text-[10px] font-black uppercase tracking-widest mb-16"></p>
            <div id="btn-container" class="w-full max-w-xs"></div>
        </div>
    </section>

    <section id="logs" class="section">
        <div class="max-w-md mx-auto pt-10">
            <h2 class="font-logo text-[10px] text-center text-gray-500 mb-8 tracking-[0.4em]">REGISTROS</h2>
            <div class="glass p-4 mb-6 flex gap-2">
                <input type="date" id="date-picker" onchange="updateUI()" class="flex-1 bg-transparent text-white font-bold outline-none text-sm">
                <button onclick="goToday()" class="bg-white text-black text-[9px] font-black px-4 py-2 rounded-lg">HOY</button>
            </div>
            <div class="grid gap-4 mb-8">
                <div class="glass p-6"><p class="text-[9px] text-gray-500 font-black uppercase mb-1">DÃ­a</p><h3 id="stat-day" class="text-3xl font-black italic">0h 00m</h3></div>
                <div class="glass p-6 border-l-4 border-white"><p class="text-[9px] text-gray-400 font-black uppercase mb-1">Semana</p><h3 id="stat-week" class="text-4xl font-black italic">0h 00m</h3></div>
                <div class="glass p-6"><p class="text-[9px] text-gray-500 font-black uppercase mb-1">Mes</p><h3 id="stat-month" class="text-2xl font-black italic">0h 00m</h3></div>
            </div>
            <div class="flex justify-between items-center mb-4 px-2">
                <button onclick="clearHistory()" class="text-red-600 text-[8px] font-black uppercase opacity-50">Limpiar registros</button>
                <button onclick="exportCSV()" class="bg-white text-black text-[10px] font-black px-4 py-2 rounded-full italic">CSV</button>
            </div>
            <div id="log-list" class="space-y-2"></div>
        </div>
    </section>

    <section id="profile" class="section">
        <div class="max-w-md mx-auto pt-10">
            <h2 class="font-logo text-[10px] text-center text-gray-500 mb-12 tracking-[0.4em]">AJUSTES</h2>
            <div class="glass p-8 space-y-6">
                <input type="text" id="user-name" oninput="saveName()" class="w-full bg-white/5 border border-white/10 p-5 rounded-2xl text-white font-black text-center outline-none uppercase" placeholder="TU NOMBRE">
                <button onclick="Notification.requestPermission()" class="w-full bg-white text-black p-4 rounded-xl text-[10px] font-black tracking-widest uppercase italic">ðŸ”” ACTIVAR ALERTAS</button>
                <div class="pt-20 text-center">
                    <button onclick="fullReset()" class="text-red-900 text-[8px] font-black uppercase opacity-40 tracking-widest">Borrar todo el sistema</button>
                </div>
            </div>
        </div>
    </section>

    <nav>
        <button onclick="showTab('home')" id="tab-home" class="nav-btn active">Inicio</button>
        <button onclick="showTab('logs')" id="tab-logs" class="nav-btn">Panel</button>
        <button onclick="showTab('profile')" id="tab-profile" class="nav-btn">Perfil</button>
    </nav>

    <script>
        // Lluvia
        const c=document.getElementById('rainCanvas'); const ctx=c.getContext('2d');
        let w, h, drops=[];
        function resize(){ w=c.width=window.innerWidth; h=c.height=window.innerHeight; }
        class Drop { constructor(){this.init();} init(){this.x=Math.random()*w; this.y=Math.random()*-h; this.l=Math.random()*15+5; this.s=Math.random()*10+5; this.o=Math.random()*0.2;} draw(){ctx.strokeStyle=`rgba(255,255,255,${this.o})`; ctx.beginPath(); ctx.moveTo(this.x,this.y); ctx.lineTo(this.x,this.y+this.l); ctx.stroke();} update(){this.y+=this.s; if(this.y>h)this.init();}}
        function setup(){ resize(); drops=Array.from({length:70},()=>new Drop()); anim(); }
        function anim(){ ctx.clearRect(0,0,w,h); drops.forEach(d=>{d.draw(); d.update();}); requestAnimationFrame(anim); }
        window.onresize=resize; setup();

        // LÃ³gica - UNIFICADO bc_data_v17
        let data = JSON.parse(localStorage.getItem('bc_data_v17')) || [];
        let stats = JSON.parse(localStorage.getItem('bc_stats_v17')) || {};
        let isInside = localStorage.getItem('bc_in_v17') === 'true';
        const picker = document.getElementById('date-picker');

        function showTab(id) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            document.getElementById('tab-'+id).classList.add('active');
            updateUI();
        }

        function saveName() { localStorage.setItem('bc_name_v17', document.getElementById('user-name').value); }
        function goToday() { picker.value = new Date().toISOString().split('T')[0]; updateUI(); }

        function getKeys(d) {
            const date = new Date(d);
            const dayK = date.toLocaleDateString('es-ES');
            const monthK = `${date.getFullYear()}-${date.getMonth()+1}`;
            const temp = new Date(date);
            const diff = temp.getDate() - temp.getDay() + (temp.getDay() === 0 ? -6 : 1);
            const weekK = `W-${new Date(temp.setDate(diff)).toLocaleDateString('es-ES')}`;
            return { dayK, weekK, monthK };
        }

        function updateUI() {
            const keys = getKeys(picker.value + "T00:00:00");
            document.getElementById('stat-day').innerText = fmt(stats[keys.dayK] || 0);
            document.getElementById('stat-week').innerText = fmt(stats[keys.weekK] || 0);
            document.getElementById('stat-month').innerText = fmt(stats[keys.monthK] || 0);
            const list = document.getElementById('log-list');
            list.innerHTML = '';
            data.filter(l => l.f === keys.dayK).reverse().forEach(l => {
                list.innerHTML += `<div class="glass p-4 flex justify-between items-center border-l-2 ${l.t==='entrada'?'border-white':'border-red-600'}">
                    <span class="text-[9px] font-black uppercase ${l.t==='entrada'?'':'text-red-500'}">${l.t}</span>
                    <span class="font-black italic text-lg">${l.h}</span>
                </div>`;
            });
            const btnZone = document.getElementById('btn-container');
            if(btnZone) {
                btnZone.innerHTML = !isInside ? 
                `<button onclick="fichar('entrada')" class="w-full bg-white text-black py-7 rounded-[2rem] font-black text-lg tracking-[0.2em]">FICHAR ENTRADA</button>` :
                `<button onclick="fichar('salida')" class="w-full bg-red-600 text-white py-7 rounded-[2rem] font-black text-lg tracking-[0.2em]">FICHAR SALIDA</button>`;
            }
        }

        function fichar(t) {
            if(!localStorage.getItem('bc_name_v17')) { alert("Pon tu nombre en Perfil"); showTab('profile'); return; }
            const now = new Date(); const keys = getKeys(now);
            if(t==='salida' && isInside) {
                const last = [...data].reverse().find(r => r.t==='entrada');
                if(last) {
                    const diff = now.getTime() - last.ts;
                    stats[keys.dayK]=(stats[keys.dayK]||0)+diff; stats[keys.weekK]=(stats[keys.weekK]||0)+diff; stats[keys.monthK]=(stats[keys.monthK]||0)+diff;
                    localStorage.setItem('bc_stats_v17', JSON.stringify(stats));
                }
            }
            data.push({t, ts: now.getTime(), f: keys.dayK, h: now.toLocaleTimeString('es-ES',{hour:'2-digit',minute:'2-digit'})});
            isInside = (t==='entrada');
            
            // Guardado corregido para que sea persistente
            localStorage.setItem('bc_data_v17', JSON.stringify(data));
            localStorage.setItem('bc_in_v17', isInside);
            updateUI();
        }

        function fmt(ms) { const h=Math.floor(ms/3600000); const m=Math.floor((ms%3600000)/60000); return `${h}h ${m}m`; }
        function tick() {
            const n = new Date();
            const clockEl = document.getElementById('clock');
            const dateEl = document.getElementById('date-display');
            if(clockEl) clockEl.innerText = n.toLocaleTimeString('es-ES',{hour:'2-digit',minute:'2-digit',hour12:false});
            if(dateEl) dateEl.innerText = n.toLocaleDateString('es-ES',{weekday:'long',day:'numeric',month:'long'});
        }
        setInterval(tick, 1000);
        function clearHistory() { if(confirm("Â¿Borrar fichajes?")) { data=[]; stats={}; localStorage.setItem('bc_data_v17','[]'); localStorage.setItem('bc_stats_v17','{}'); updateUI(); } }
        function fullReset() { if(confirm("Â¿RESET TOTAL?")) { localStorage.clear(); location.reload(); } }
        function exportCSV() {
            let csv = "\uFEFFFecha,Accion,Hora\n";
            data.forEach(d => { csv += `${d.f},${d.t},${d.h}\n`; });
            const b = new Blob([csv], {type:'text/csv;charset=utf-8;'});
            const a = document.createElement('a'); a.href = URL.createObjectURL(b); a.download = `Log.csv`; a.click();
        }

        picker.value = new Date().toISOString().split('T')[0];
        const savedN = localStorage.getItem('bc_name_v17');
        if(savedN) document.getElementById('user-name').value = savedN;
        tick(); updateUI();
    </script>
</body>
</html>
